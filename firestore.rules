rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // YA 2026 Forensic Ledger Guardrails
    match /artifacts/{appId}/public/data/ledgerEntries/{docId} {
      
      // SENTINEL: Authorative Read/Write
      allow read: if request.auth != null;
      
      allow create, update: if request.auth != null 
        && isValidLedgerEntry(request.resource.data)
        && !isLocked(resource.data);

      // Rule 1: Immutable Approval (FOUNDER LOCK)
      function isLocked(data) {
        return data != null && data.auditStatus == 'APPROVED';
      }

      // Rule 2: Mandatory Documentation for RM 500+ Threshold
      function isValidLedgerEntry(data) {
        return data.amount is number 
          && (data.amount <= 500 || (data.amount > 500 && data.supportingDocLinks is list && data.supportingDocLinks.size() > 0));
      }
    }
    
    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
