rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 1. SPECIFIC: RPR-KONTROL Governance Namespace (Auditors Only)
    match /governance/{document=**} {
      allow read, write: if request.auth != null
        && request.auth.token.role == 'auditor';
    }

    // 2. GENERAL: Main App Entity Data (Standard Users)
    match /entities/{entityId}/{document=**} {
      allow read, write: if request.auth != null
        && request.auth.uid == resource.data.ownerId;
    }

    // 3. Allow authenticated users to read and write to the 'transactions' collection
    match /transactions/{transactionId} {
      allow read, delete: if request.auth != null;
      
      // On create or update, validate the data with our function
      allow write: if request.auth != null && isValidTransaction();
    }

    // 4. GLOBAL DENY: Everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }

  function isValidTransaction() {
    let transaction = request.resource.data;

    // Basic data integrity checks
    let isStructurallySound = transaction.description is string &&
                              transaction.debit is number &&
                              transaction.credit is number &&
                              transaction.date is string &&
                              transaction.category is string &&
                              transaction.status is string;

    // **Staff Welfare Compliance Rule**
    // PREVENT a 'Staff Welfare' transaction from being marked 'AUDIT_READY'
    // if its debit value exceeds the 5000 threshold.
    // It must be submitted with a different status (e.g., 'New') to be
    // processed and flagged correctly by the backend Cloud Function.
    let isWelfareCompliant = !(transaction.category == 'Staff Welfare' &&
                               transaction.debit > 5000 &&
                               transaction.status == 'AUDIT_READY');

    return isStructurallySound && isWelfareCompliant;
  }
}
